<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Servers - Server Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Manage Servers</h1>
            <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
        </header>

        <div class="manage-container">
            <p class="drag-hint">üí° Drag and drop servers to reorder them</p>
            <div id="server-list" class="server-list">
                <!-- Server items will be dynamically inserted here -->
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="edit-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Server</h2>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                <form id="edit-form">
                    <input type="hidden" id="edit-id">
                    
                    <div class="form-group">
                        <label for="edit-title">Server Title *</label>
                        <input type="text" id="edit-title" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-url">URL/Alias</label>
                        <input type="text" id="edit-url">
                    </div>

                    <div class="form-group">
                        <label for="edit-localIp">Local IP Address & Port</label>
                        <input type="text" id="edit-localIp">
                    </div>

                    <div class="form-group">
                        <label for="edit-sshIp">SSH IP Address</label>
                        <input type="text" id="edit-sshIp">
                    </div>

                    <div class="form-group">
                        <label for="edit-username">Admin Username</label>
                        <input type="text" id="edit-username">
                    </div>

                    <div class="form-group">
                        <label for="edit-description">Description</label>
                        <textarea id="edit-description" rows="4"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script src="script.js"></script>
    <script>
        let currentServers = [];

        async function loadServers() {
            try {
                const response = await fetch('/api/servers');
                const data = await response.json();
                currentServers = data.servers || [];
                displayServerList(currentServers);
            } catch (error) {
                console.error('Error loading servers:', error);
                displayServerList([]);
            }
        }

        function displayServerList(servers) {
            const list = document.getElementById('server-list');
            
            if (servers.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>No servers to manage.</p></div>';
                return;
            }

            list.innerHTML = servers.map((server, index) => `
                <div class="manage-item" draggable="true" data-id="${server.id}" data-index="${index}">
                    <div class="drag-handle" title="Drag to reorder">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </div>
                    <div class="manage-item-info">
                        <h3>${escapeHtml(server.title)}</h3>
                        <p class="manage-detail">${escapeHtml(server.url || 'No URL')} ‚Ä¢ ${escapeHtml(server.localIp || 'No IP')}</p>
                    </div>
                    <div class="manage-item-actions">
                        <button class="btn-icon edit-btn" onclick="editServer('${server.id}')" title="Edit">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn-icon delete-btn" onclick="deleteServer('${server.id}')" title="Delete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');

            // Add drag and drop event listeners
            initDragAndDrop();
        }

        function editServer(id) {
            const server = currentServers.find(s => s.id === id);
            if (!server) return;

            document.getElementById('edit-id').value = server.id;
            document.getElementById('edit-title').value = server.title;
            document.getElementById('edit-url').value = server.url;
            document.getElementById('edit-localIp').value = server.localIp;
            document.getElementById('edit-sshIp').value = server.sshIp;
            document.getElementById('edit-username').value = server.username;
            document.getElementById('edit-description').value = server.description;

            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        async function deleteServer(id) {
            if (!confirm('Are you sure you want to delete this server?')) return;

            try {
                const response = await fetch(`/api/servers/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Server deleted successfully!');
                    loadServers(); // Reload the list
                } else {
                    showToast('Error: ' + (result.error || 'Failed to delete'));
                }
            } catch (error) {
                showToast('Error: ' + error.message);
            }
        }

        document.getElementById('edit-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('edit-id').value;
            const updatedServer = {
                title: document.getElementById('edit-title').value,
                url: document.getElementById('edit-url').value || '',
                localIp: document.getElementById('edit-localIp').value || '',
                sshIp: document.getElementById('edit-sshIp').value || '',
                username: document.getElementById('edit-username').value || '',
                description: document.getElementById('edit-description').value || ''
            };

            try {
                const response = await fetch(`/api/servers/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedServer)
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Server updated successfully!');
                    loadServers(); // Reload the list
                    closeModal();
                } else {
                    showToast('Error: ' + (result.error || 'Failed to update'));
                }
            } catch (error) {
                showToast('Error: ' + error.message);
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Drag and drop functionality
        let draggedElement = null;
        let draggedIndex = null;

        function initDragAndDrop() {
            const items = document.querySelectorAll('.manage-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            this.classList.remove('drag-over');

            if (draggedElement !== this) {
                const dropIndex = parseInt(this.dataset.index);
                
                // Reorder the array
                const newServers = [...currentServers];
                const [removed] = newServers.splice(draggedIndex, 1);
                newServers.splice(dropIndex, 0, removed);
                
                // Update the server order
                currentServers = newServers;
                
                // Save the new order to the server
                await saveServerOrder(currentServers);
                
                // Refresh the display
                displayServerList(currentServers);
            }

            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            // Remove all drag-over classes
            document.querySelectorAll('.manage-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        async function saveServerOrder(servers) {
            try {
                const response = await fetch('/api/servers/reorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ servers })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Order updated successfully!');
                } else {
                    showToast('Error: ' + (result.error || 'Failed to save order'));
                }
            } catch (error) {
                showToast('Error: ' + error.message);
            }
        }

        loadServers();
    </script>
</body>
</html>